rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Reviews - Public read, users can manage their own review
    match /reviews/{userId} {
      allow read: if true;
      allow create: if isSignedIn()
        && userId == request.auth.uid
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.rating is number
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && request.resource.data.comment is string
        && request.resource.data.comment.size() <= 1000;
      allow update: if isSignedIn()
        && userId == request.auth.uid;
      allow delete: if isAdmin() || (isSignedIn() && userId == request.auth.uid);
    }

    // Product Reviews - Only approved reviews are publicly readable
    match /productReviews/{reviewId} {
      // Public can read only approved reviews
      allow read: if resource.data.status == 'approved';
      // Admins can read all reviews
      allow list: if isAdmin();
      // Users can create reviews if authenticated and it's their own review
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.productId is string
        && request.resource.data.orderId is string
        && request.resource.data.rating is number
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && request.resource.data.title is string
        && request.resource.data.title.size() >= 5
        && request.resource.data.title.size() <= 100
        && request.resource.data.comment is string
        && request.resource.data.comment.size() >= 20
        && request.resource.data.comment.size() <= 1000
        && request.resource.data.status == 'pending'
        && request.resource.data.verified == true;
      // Users can update helpful votes on their own reviews
      allow update: if isSignedIn()
        && (
          // Admin can approve/reject/respond to any review
          isAdmin()
          // User can toggle helpful on any review (helpfulBy array)
          || (resource.data.userId != request.auth.uid 
              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['helpful', 'helpfulBy']))
        );
      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // Products - Public read, Admin write
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Categories - Public read, Admin write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Models - Public read, Admin write
    match /models/{modelId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Materials - Public read, Admin write
    match /materials/{materialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tags - Public read, Admin write
    match /tags/{tagId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Size Groups - Public read, Admin write
    match /sizes/{sizeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Templates - Admin only (should not be public)
    match /templates/{templateId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Benefit Templates - Public read, Admin write
    match /benefitTemplates/{templateId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Gallery Categories - Public read, Admin write
    match /galleryCategories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Gallery Images - Public read, Admin write
    match /galleryImages/{imageId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Media - Public read, Admin write (for product covers and gallery images)
    match /media/{mediaId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Technical Data - Public read, Admin write
    match /technicalData/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Users - Users can read/write own data, Admins can read/update all
    match /users/{userId} {
      // Allow users to read their own profile
      allow read: if isOwner(userId) || isAdmin();
      // Allow creating new users during registration
      allow create: if isSignedIn();
      // Allow users to update their own profile, admins can update any
      allow update: if isOwner(userId) || isAdmin();
      // No one can delete user documents
      allow delete: if false;
      // Allow listing users for authentication purposes (checking locks before sign-in)
      // This is needed for the sign-in flow to check if account is locked
      allow list: if true;
    }

    // Carts - Users can read/write their own cart, allow anonymous temp carts
    match /carts/{cartId} {
      // Allow user to access their own cart (cartId = uid)
      // Allow read even if cart doesn't exist yet (for initial load)
      allow read: if isSignedIn() && cartId == request.auth.uid;
      allow write: if isSignedIn() && cartId == request.auth.uid;
      
      // Allow anonymous cart creation and access (temp ID that upgrades on sign-in)
      allow read, write: if cartId.matches('^anon_[a-zA-Z0-9_]+$');
    }

    // Addresses - Users can read/write their own addresses
    match /users/{userId}/addresses/{addressId} {
      allow read, write: if isOwner(userId);
      allow list: if isOwner(userId);
    }

    // Orders - Users can create and read own orders, Admins can read/update all
    match /orders/{orderId} {
      allow read: if isAdmin() || 
                    (isSignedIn() && resource.data.uid == request.auth.uid);
      // Allow order creation only if user is authenticated and uid matches
      allow create: if isSignedIn() && 
                      request.resource.data.uid == request.auth.uid;
      // Only admins can update orders (status changes, etc.)
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Surveys - Public read for stats, authenticated users can create
    match /surveys/{surveyId} {
      allow read: if true; // Public read for calculating stats
      allow create: if isSignedIn(); // Users can submit surveys
      allow update, delete: if isAdmin(); // Only admins can modify
    }

    // Payments - Read-only for users (their own), write access for backend/webhooks only
    match /payments/{paymentId} {
      allow read: if isAdmin() || 
                    (isSignedIn() && resource.data.uid == request.auth.uid);
      // Payments are created/updated by backend Cloud Functions only
      allow write: if false;
    }

    // Webhook Logs - Admin read-only (created by backend)
    match /webhooks_log/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Promo Codes - Public read (to validate), Admin write
    match /promoCodes/{codeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Settings
    match /settings/{settingId} {
      // Allow admins to read and write all settings documents
      allow read, write: if isAdmin();
      // Allow public read for the 'public' document
      allow read: if settingId == 'public';
    }

    // Mail collection for contact form (Brevo integration)
    match /mail/{document} {
      allow create: if resource == null
        && request.resource.data.keys().hasAll(['to', 'message'])
        && request.resource.data.to is list
        && request.resource.data.to.size() <= 3
        && request.resource.data.message.keys().hasAll(['subject', 'html'])
        && (
          // Allow hardcoded safe emails
          request.resource.data.to[0] in ['support@theluxmining.com', 'contact@theluxmining.com', 'xsantcastx@xsantcastx.com']
          // OR allow email from settings (admins can configure it)
          || request.resource.data.to[0] == get(/databases/$(database)/documents/settings/app-settings).data.contactEmail
        );
      
      allow read: if false;
      allow update, delete: if false;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
