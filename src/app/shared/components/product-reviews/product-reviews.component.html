<div class="product-reviews py-12">
  <!-- Reviews Summary -->
  @if (summary()) {
    <div class="mb-12">
      <div class="flex flex-col lg:flex-row gap-8 items-start">
        <!-- Average Rating -->
        <div class="flex-shrink-0 text-center lg:text-left">
          <div class="text-6xl font-bold bitcoin-gradient-text mb-2">
            {{ summary()!.averageRating | number:'1.1-1' }}
          </div>
          <div class="flex items-center justify-center lg:justify-start gap-1 mb-2">
            @for (star of getStarArray(5); track $index) {
              <svg class="w-6 h-6" [class.text-bitcoin-orange]="$index < summary()!.averageRating" [class.text-bitcoin-gray/30]="$index >= summary()!.averageRating" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            }
          </div>
          <p class="text-sm text-bitcoin-gray">
            {{ summary()!.totalReviews }} {{ summary()!.totalReviews === 1 ? 'review' : 'reviews' }}
          </p>
          <p class="text-xs text-bitcoin-gray/70 mt-1">
            {{ summary()!.verifiedPurchaseCount }} verified purchases
          </p>
        </div>

        <!-- Rating Distribution -->
        <div class="flex-1 w-full">
          @for (rating of [5, 4, 3, 2, 1]; track rating) {
            <div class="flex items-center gap-3 mb-2">
              <span class="text-sm text-bitcoin-gray w-12">{{ rating }} star</span>
              <div class="flex-1 h-2 bg-bitcoin-dark rounded-full overflow-hidden">
                <div class="h-full bg-bitcoin-orange transition-all duration-300" [style.width.%]="getRatingPercentage(rating)"></div>
              </div>
              <span class="text-sm text-bitcoin-gray w-12 text-right">
                {{ getRatingCount(rating) }}
              </span>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Write Review Button -->
  @if (canReview()) {
    <div class="mb-8">
      <button
        type="button"
        (click)="toggleReviewForm()"
        class="px-6 py-3 bg-bitcoin-orange hover:bg-bitcoin-orange/90 text-white font-bold rounded-xl transition-all shadow-bitcoin">
        {{ showReviewForm() ? 'Cancel Review' : 'Write a Review' }}
      </button>
    </div>
  } @else if (canReviewReason()) {
    <div class="mb-8 p-4 bg-bitcoin-dark/40 border border-bitcoin-gray/20 rounded-xl">
      <p class="text-sm text-bitcoin-gray">{{ canReviewReason() }}</p>
    </div>
  }

  <!-- Review Form -->
  @if (showReviewForm()) {
    <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="mb-12 p-6 bg-bitcoin-dark/40 border border-bitcoin-orange/20 rounded-xl">
      <h3 class="text-xl font-serif bitcoin-gradient-text mb-6">Write Your Review</h3>

      <!-- Success/Error Messages -->
      @if (success()) {
        <div class="mb-4 p-4 bg-green-500/20 border border-green-500/30 rounded-lg text-green-300">
          {{ success() }}
        </div>
      }
      @if (error()) {
        <div class="mb-4 p-4 bg-red-500/20 border border-red-500/30 rounded-lg text-red-300">
          {{ error() }}
        </div>
      }

      <!-- Rating -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-bitcoin-gray mb-3">Your Rating *</label>
        <div class="flex gap-2">
          @for (star of getStarArray(5); track $index) {
            <button
              type="button"
              (click)="setRating($index + 1)"
              class="focus:outline-none focus:ring-2 focus:ring-bitcoin-orange rounded">
              <svg class="w-10 h-10 transition-all hover:scale-110" [class.text-bitcoin-orange]="$index < reviewForm.value.rating!" [class.text-bitcoin-gray/30]="$index >= reviewForm.value.rating!" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            </button>
          }
        </div>
      </div>

      <!-- Title -->
      <div class="mb-6">
        <label for="review-title" class="block text-sm font-semibold text-bitcoin-gray mb-2">
          Review Title *
        </label>
        <input
          id="review-title"
          type="text"
          formControlName="title"
          placeholder="Summarize your experience"
          class="w-full px-4 py-3 rounded-xl bg-bitcoin-dark/60 border border-bitcoin-gray/20 text-white placeholder-bitcoin-gray/50 focus:ring-2 focus:ring-bitcoin-orange focus:border-bitcoin-orange"
          [class.border-red-500]="reviewForm.get('title')?.touched && reviewForm.get('title')?.errors">
        @if (reviewForm.get('title')?.touched && reviewForm.get('title')?.errors) {
          <p class="text-red-400 text-xs mt-1">Please enter a title (5-100 characters)</p>
        }
      </div>

      <!-- Comment -->
      <div class="mb-6">
        <label for="review-comment" class="block text-sm font-semibold text-bitcoin-gray mb-2">
          Your Review *
        </label>
        <textarea
          id="review-comment"
          formControlName="comment"
          rows="6"
          placeholder="Tell us about your experience with this product"
          class="w-full px-4 py-3 rounded-xl bg-bitcoin-dark/60 border border-bitcoin-gray/20 text-white placeholder-bitcoin-gray/50 focus:ring-2 focus:ring-bitcoin-orange focus:border-bitcoin-orange resize-none"
          [class.border-red-500]="reviewForm.get('comment')?.touched && reviewForm.get('comment')?.errors"></textarea>
        @if (reviewForm.get('comment')?.touched && reviewForm.get('comment')?.errors) {
          <p class="text-red-400 text-xs mt-1">Please write at least 20 characters</p>
        }
        <p class="text-xs text-bitcoin-gray/70 mt-1">
          {{ reviewForm.value.comment?.length || 0 }} / 1000 characters
        </p>
      </div>

      <!-- Submit Button -->
      <div class="flex gap-4">
        <button
          type="submit"
          [disabled]="submitting() || reviewForm.invalid"
          class="px-6 py-3 bg-bitcoin-orange hover:bg-bitcoin-orange/90 text-white font-bold rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          {{ submitting() ? 'Submitting...' : 'Submit Review' }}
        </button>
        <button
          type="button"
          (click)="toggleReviewForm()"
          class="px-6 py-3 bg-transparent border-2 border-bitcoin-gray/30 text-bitcoin-gray hover:border-bitcoin-orange/50 hover:text-bitcoin-orange rounded-xl transition-all">
          Cancel
        </button>
      </div>
    </form>
  }

  <!-- Reviews List -->
  @if (loading()) {
    <div class="flex items-center justify-center py-12">
      <div class="app-spinner" style="--spinner-size: 72px;"><img src="/Logo Clear.png" alt="Loading" width="96" height="96"></div>
    </div>
  } @else if (reviews().length === 0) {
    <div class="text-center py-12">
      <svg class="w-16 h-16 text-bitcoin-gray/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
      </svg>
      <p class="text-bitcoin-gray">No reviews yet. Be the first to review this product!</p>
    </div>
  } @else {
    <div class="space-y-6">
      @for (review of reviews(); track review.id) {
        <div class="p-6 bg-bitcoin-dark/40 border border-bitcoin-gray/20 rounded-xl hover:border-bitcoin-orange/20 transition-all">
          <!-- Review Header -->
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <div class="flex gap-1">
                  @for (star of getStarArray(review.rating); track $index) {
                    <svg class="w-5 h-5 text-bitcoin-orange" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                  }
                </div>
                @if (review.verified) {
                  <span class="text-xs bg-bitcoin-orange/20 text-bitcoin-orange px-2 py-1 rounded-full border border-bitcoin-orange/30">
                    ✓ Verified Purchase
                  </span>
                }
              </div>
              <h4 class="text-lg font-semibold text-white mb-1">{{ review.title }}</h4>
              <p class="text-sm text-bitcoin-gray">
                By {{ review.userName }} • {{ formatDate(review.createdAt) }}
              </p>
            </div>
          </div>

          <!-- Review Content -->
          <p class="text-bitcoin-gray mb-4 leading-relaxed">{{ review.comment }}</p>

          <!-- Admin Response -->
          @if (review.adminResponse) {
            <div class="mt-4 p-4 bg-bitcoin-orange/10 border-l-4 border-bitcoin-orange rounded">
              <p class="text-sm font-semibold text-bitcoin-orange mb-2">Response from {{ review.adminResponse.respondedBy }}</p>
              <p class="text-sm text-bitcoin-gray">{{ review.adminResponse.message }}</p>
              <p class="text-xs text-bitcoin-gray/70 mt-2">{{ formatDate(review.adminResponse.respondedAt) }}</p>
            </div>
          }

          <!-- Helpful Button -->
          <div class="mt-4 pt-4 border-t border-bitcoin-gray/20">
            <button
              type="button"
              (click)="markHelpful(review.id!)"
              [class.text-bitcoin-orange]="isHelpfulMarkedByUser(review)"
              [class.text-bitcoin-gray]="!isHelpfulMarkedByUser(review)"
              class="flex items-center gap-2 hover:text-bitcoin-orange transition-colors text-sm">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
              </svg>
              Helpful ({{ review.helpful }})
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>

