# Combined Preview (PR) + Production (main) deploy
# Auto-generated base by Firebase CLI; consolidated by hand

name: Firebase Hosting (PR preview + main live)

on:
  pull_request:
  push:
    branches: [main]

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Optional but recommended for reproducible builds
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # 🔐 SECURE: Generate environment files from templates + secrets
      - name: Generate environment.ts
        run: |
          mkdir -p src/environments
          sed -e "s#__FIREBASE_API_KEY__#${{ secrets.FIREBASE_API_KEY }}#g" \
              -e "s#__FIREBASE_APP_ID__#${{ secrets.FIREBASE_APP_ID }}#g" \
              -e "s#__FIREBASE_MEASUREMENT_ID__#${{ secrets.FIREBASE_MEASUREMENT_ID }}#g" \
              -e "s#__RECAPTCHA_SITE_KEY__#${{ secrets.RECAPTCHA_SITE_KEY }}#g" \
              src/environments/environment.template.ts > src/environments/environment.ts
              
      - name: Generate environment.prod.ts
        run: |
          mkdir -p src/environments
          sed -e "s#__FIREBASE_API_KEY__#${{ secrets.FIREBASE_API_KEY }}#g" \
              -e "s#__FIREBASE_APP_ID__#${{ secrets.FIREBASE_APP_ID }}#g" \
              -e "s#__FIREBASE_MEASUREMENT_ID__#${{ secrets.FIREBASE_MEASUREMENT_ID }}#g" \
              -e "s#__RECAPTCHA_SITE_KEY__#${{ secrets.RECAPTCHA_SITE_KEY }}#g" \
              src/environments/environment.prod.template.ts > src/environments/environment.prod.ts

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      # ---- PR PREVIEW DEPLOY ----
      # Only run on PRs from the same repo (skip forks)
      - name: Deploy preview (PR)
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CREADEVENTS_437A8 }}
          projectId: creadevents-437a8
          # no channelId => Firebase creates an ephemeral preview channel per PR

      # ---- PRODUCTION DEPLOY ----
      - name: Deploy live (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CREADEVENTS_437A8 }}
          projectId: creadevents-437a8
          channelId: live
